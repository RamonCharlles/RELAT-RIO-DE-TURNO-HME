ed<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Turno Operacional - Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-[#0f172a] min-h-screen pb-10 text-slate-100 font-sans">

    <div class="max-w-3xl mx-auto bg-[#1e293b] shadow-2xl border-t-4 border-blue-500 mt-5 rounded-lg overflow-hidden">
        <div class="p-6 border-b border-slate-700 bg-[#1e293b]">
            <h1 class="text-2xl font-black flex items-center gap-2 text-white italic uppercase tracking-tighter">
                <i class="fas fa-clipboard-list text-blue-500"></i> Relat√≥rio de Turno
            </h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Data do Turno *</label>
                    <input type="date" id="dataTurno" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-700 outline-none focus:border-blue-500 text-xs">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Turno</label>
                    <select id="turno" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-700 outline-none focus:border-blue-500 text-xs">
                        <option value="T1">T1 (07:00-15:00)</option>
                        <option value="T2">T2 (15:00-23:00)</option>
                        <option value="T3">T3 (23:00-07:00)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Letra</label>
                    <select id="letra" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-700 outline-none focus:border-blue-500 text-xs">
                        <option>A</option><option>B</option><option>C</option><option>D</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Respons√°vel *</label>
                    <input type="text" id="operador" placeholder="Nome" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-700 outline-none focus:border-blue-500 text-xs">
                </div>
            </div>
        </div>

        <div id="listaEquipamentos" class="p-4 space-y-6"></div>

        <div class="p-6 bg-[#1e293b] border-t border-slate-700">
            <button onclick="enviarTudo()" id="btnFinalizar" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all transform active:scale-95">
                <i class="fas fa-paper-plane"></i> FINALIZAR E ENVIAR RELAT√ìRIO
            </button>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxRq4RwoWzsF2hMZNFEaQogtOChN_zKwz5gPXsPGknpm17T49xYi08MYkQbzDp4sSPX1Q/exec";
        
        const frotas = {
            "JUMBOS": ["JB01","JB02","JB04","JB05"],
            "SIMBAS": ["SB01","SB02","SB04"],
            "LHDS": ["CG01","CG04","CG08"],
            "CARREGADEIRAS CONVENCIONAIS": ["CG02","CG07"],
            "CAMINH√ïES": ["CE06", " CE07","CE08","CE09","CE10","CE11","CE12","CE13"],
            "APOIO": ["Trator TE01", "Retroescavadeira RT05", "Retroescavadeira RT06", "Manipuladora MT04", "Manipuladora MT05", "Manipuladora MT06", "Manipuladora MT07", "Motoniveladora MN01"]
        };

        const metasDF = { "JUMBOS": 80, "SIMBAS": 70, "CARREGADEIRAS": 70, "CAMINH√ïES": 75, "LHDS": 70, "APOIO": 85 };
        const limitesTurno = { "T1": { i: "07:00", f: "15:00" }, "T2": { i: "15:00", f: "23:00" }, "T3": { i: "23:00", f: "07:00" } };

        document.getElementById('dataTurno').valueAsDate = new Date();

        function renderizar() {
            const container = document.getElementById('listaEquipamentos');
            container.innerHTML = ''; 
            let globalIdx = 0;

            for (let frota in frotas) {
                container.innerHTML += `<h2 class="text-blue-500 font-black text-xs mt-6 mb-2 border-l-4 border-blue-500 pl-2 uppercase italic"><i class="fas fa-layer-group mr-2"></i>${frota}</h2>`;
                frotas[frota].forEach((eq) => {
                    container.innerHTML += `
                        <div class="border border-slate-700 rounded-xl p-4 bg-slate-800/40 equip-card mb-4" data-equip="${eq}" data-frota="${frota}">
                            <div class="flex justify-between items-center border-b border-slate-700 pb-3 mb-4 gap-2">
                                <h3 class="font-black text-white text-sm uppercase tracking-wider whitespace-nowrap">${eq}</h3>
                                <div class="flex flex-col flex-1 items-end gap-2">
                                    <select onchange="toggleMotivoStatus(this)" class="status-geral bg-slate-900 p-2 rounded font-bold text-[10px] border border-slate-700 text-white w-full max-w-[150px]">
                                        <option value="Dispon√≠vel">‚úÖ Dispon√≠vel</option>
                                        <option value="Preventiva/PitStop">üõ†Ô∏è Preventiva/PitStop</option>
                                        <option value="Corretiva">‚ùå Corretiva</option>
                                        <option value="Manuten√ß√£o Externa">üö® Servi√ßo Externo</option>
                                    </select>
                                    <input type="text" placeholder="Qual o motivo do status? *" class="input-motivo-status hidden w-full bg-slate-900 p-2 rounded text-[10px] border border-amber-500 text-white outline-none">
                                </div>
                            </div>
                            <div id="paradas-${globalIdx}" class="space-y-4"></div>
                            <button type="button" onclick="addParada(${globalIdx})" class="mt-4 text-[10px] font-bold bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded flex items-center gap-2 transition shadow-md uppercase">
                                <i class="fas fa-plus-circle"></i> Iniciar Interven√ß√£o
                            </button>
                        </div>
                    `;
                    globalIdx++;
                });
            }
        }

        function toggleMotivoStatus(select) {
            const inputMotivo = select.parentElement.querySelector('.input-motivo-status');
            if(select.value === "Corretiva" || select.value === "Manuten√ß√£o Externa") {
                inputMotivo.classList.remove('hidden');
            } else {
                inputMotivo.classList.add('hidden');
                inputMotivo.value = "";
            }
        }

        function addParada(idx) {
            const container = document.getElementById(`paradas-${idx}`);
            const div = document.createElement('div');
            div.className = "bg-slate-900 p-4 rounded-lg border-l-4 border-amber-500 relative mt-2 parada-item";
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-slate-500 hover:text-red-500"><i class="fas fa-trash"></i></button>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div><label class="text-[9px] font-bold text-slate-500 uppercase">In√≠cio</label>
                    <input type="time" class="h-ini w-full p-2 bg-slate-800 border border-slate-700 rounded text-white text-xs"></div>
                    <div><label class="text-[9px] font-bold text-slate-500 uppercase">Fim</label>
                    <input type="time" class="h-fim w-full p-2 bg-slate-800 border border-slate-700 rounded text-white text-xs"></div>
                    <div><label class="text-[9px] font-bold text-slate-500 uppercase">Hor√≠metro</label>
                    <input type="number" step="0.1" class="horimetro w-full p-2 bg-slate-800 border border-slate-700 rounded text-white text-xs" placeholder="0.0"></div>
                </div>
                <select class="maint-status w-full p-2 mb-2 bg-slate-800 border border-slate-700 rounded text-white text-[10px]">
                    <option value="Conclu√≠do">‚úÖ Conclu√≠do</option>
                    <option value="Em Diagn√≥stico">üîç Em Diagn√≥stico</option>
                    <option value="Em Execu√ß√£o">üõ†Ô∏è Em Execu√ß√£o</option>
                    <option value="Aguardando Pe√ßa">üì¶ Aguardando Pe√ßa</option>
                </select>
                <div class="grid grid-cols-1 gap-2">
                    <input type="text" class="motivo p-2 bg-slate-800 border border-slate-700 rounded text-[11px] text-white" placeholder="Motivo da Parada *">
                    <input type="text" class="causa p-2 bg-slate-800 border border-slate-700 rounded text-[11px] text-white" placeholder="Causa Aparente *">
                    <input type="text" class="acao p-2 bg-slate-800 border border-slate-700 rounded text-[11px] text-white" placeholder="A√ß√£o Imediata *">
                    <textarea class="obs p-2 bg-slate-800 border border-slate-700 rounded text-[11px] text-white" placeholder="Observa√ß√µes Complementares"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function estaNoRange(h, t) {
            if (t === "T3") return (h >= "23:00" || h <= "07:00");
            return (h >= limitesTurno[t].i && h <= limitesTurno[t].f);
        }

        async function enviarTudo() {
            const op = document.getElementById('operador').value;
            const dt = document.getElementById('dataTurno').value;
            const turnoSel = document.getElementById('turno').value;
            if(!dt || !op) return alert("Preencha Data e Respons√°vel!");

            const logs = [];
            let valid = true;
            let msgErro = "";

            document.querySelectorAll('.equip-card').forEach(card => {
                const eq = card.getAttribute('data-equip'), fr = card.getAttribute('data-frota'), st = card.querySelector('.status-geral').value;
                const motivoStatus = card.querySelector('.input-motivo-status').value;
                const paradas = card.querySelectorAll('.parada-item');

                if((st === "Corretiva" || st === "Manuten√ß√£o Externa") && !motivoStatus) {
                    valid = false;
                    msgErro = `Informe o motivo do status para o equipamento ${eq}`;
                }

                if (paradas.length === 0) {
                    logs.push({ data: dt, equip: eq, frota: fr, status: st, h_ini: '-', h_fim: '-', horimetro: '-', motivo: motivoStatus || '-', causa: '-', acao: '-', maint_status: '-', obs: '-', turno: turnoSel, letra: document.getElementById('letra').value, op: op });
                } else {
                    paradas.forEach(p => {
                        const h1 = p.querySelector('.h-ini').value, h2 = p.querySelector('.h-fim').value;
                        const m = p.querySelector('.motivo').value, c = p.querySelector('.causa').value, a = p.querySelector('.acao').value;
                        const hor = p.querySelector('.horimetro').value || "-";
                        
                        if(!h1 || !h2 || !m || !c || !a) { valid = false; msgErro = "Campos obrigat√≥rios de interven√ß√£o vazios!"; }
                        if(!estaNoRange(h1, turnoSel) || !estaNoRange(h2, turnoSel)) { valid = false; msgErro = `Hora fora do turno em ${eq}`; }
                        
                        logs.push({ 
                            data: dt, equip: eq, frota: fr, status: st, 
                            h_ini: h1, h_fim: h2, horimetro: hor, motivo: m, causa: c, acao: a, 
                            maint_status: p.querySelector('.maint-status').value, 
                            obs: p.querySelector('.obs').value || "N/A", 
                            turno: turnoSel, letra: document.getElementById('letra').value, op: op 
                        });
                    });
                }
            });

            if(!valid) return alert(msgErro);

            const btn = document.getElementById('btnFinalizar');
            btn.disabled = true;
            btn.innerHTML = "ENVIANDO...";

            try {
                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(logs) });
                gerarWhats(logs);
                setTimeout(() => location.reload(), 3000);
            } catch (e) { gerarWhats(logs); }
        }

        function gerarWhats(logs) {
            const dataFmt = new Date(document.getElementById('dataTurno').value + 'T00:00:00').toLocaleDateString('pt-BR');
            let msg = `*üìä RELAT√ìRIO OPERACIONAL - ${dataFmt}*\n*TURNO:* ${document.getElementById('turno').value} | *LETRA:* ${document.getElementById('letra').value}\n*RESP:* ${document.getElementById('operador').value}\n--------------------------------\n\n`;

            const frotasUnicas = [...new Set(logs.map(l => l.frota))];

            frotasUnicas.forEach(fr => {
                const meta = metasDF[fr] || 70;
                const equipsFr = [...new Set(logs.filter(l => l.frota === fr).map(l => l.equip))];
                let somaDF = 0;
                let corpoFrota = "";

                equipsFr.forEach(eq => {
                    const logsEq = logs.filter(l => l.equip === eq);
                    let minParado = 0;
                    
                    logsEq.forEach(l => {
                        if (l.h_ini !== '-') {
                            let d = (new Date(`2000-01-01T${l.h_fim}`) - new Date(`2000-01-01T${l.h_ini}`)) / 60000;
                            minParado += d < 0 ? d + 1440 : d;
                        }
                    });

                    if (minParado === 0 && logsEq[0].status !== 'Dispon√≠vel') minParado = 480;
                    let dfEq = Math.max(0, ((480 - minParado) / 480) * 100);
                    somaDF += dfEq;
                    
                    corpoFrota += `*${eq}* (${logsEq[0].status}) | DF: ${dfEq.toFixed(1)}% ${dfEq >= meta ? 'üü¢' : 'üî¥'}\n`;
                    
                    if(logsEq.length === 1 && logsEq[0].h_ini === '-' && logsEq[0].motivo !== '-') {
                        corpoFrota += ` ‚îî üóíÔ∏è *Motivo Status:* ${logsEq[0].motivo}\n`;
                    }

                    logsEq.forEach(l => {
                        if (l.h_ini !== '-') {
                            let linhaHor = l.horimetro !== "-" ? ` | ‚öôÔ∏è H: ${l.horimetro}` : "";
                            corpoFrota += ` ‚îî ‚è±Ô∏è ${l.h_ini}-${l.h_fim}${linhaHor} | ${l.maint_status}\n`;
                            corpoFrota += ` ‚îî ‚ö†Ô∏è Motivo: ${l.motivo}\n`;
                            corpoFrota += ` ‚îî üîç Causa: ${l.causa}\n`;
                            corpoFrota += ` ‚îî ‚ö° A√ß√£o: ${l.acao}\n`;
                            if (l.obs !== "N/A") corpoFrota += ` ‚îî üóíÔ∏è Obs: ${l.obs}\n`;
                        }
                    });
                });

                let mediaFrota = somaDF / equipsFr.length;
                msg += `üîπ *FROTA: ${fr}*\n*M√âDIA DF: ${mediaFrota.toFixed(1)}%* (Meta: ${meta}%)\n`;
                msg += corpoFrota + `\n`;
            });

            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(msg));
        }

        window.onload = renderizar;
    </script>

    <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
</body>

</html>
