ed<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Turno Operacional - Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-[#0f172a] min-h-screen pb-10 text-slate-100 font-sans">

    <div class="max-w-3xl mx-auto bg-[#1e293b] shadow-2xl border-t-4 border-blue-500 mt-5 rounded-lg overflow-hidden">
        <div class="p-6 border-b border-slate-700 bg-[#1e293b]">
            <h1 class="text-2xl font-black flex items-center gap-2 text-white italic uppercase tracking-tighter">
                <i class="fas fa-clipboard-list text-blue-500"></i> Relat√≥rio de Turno
            </h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Data do Turno *</label>
                    <input type="date" id="dataTurno" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-700 outline-none focus:border-blue-500 text-xs">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Turno</label>
                    <select id="turno" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-700 outline-none focus:border-blue-500 text-xs">
                        <option value="T1">T1 (07:00-15:00)</option>
                        <option value="T2">T2 (15:00-23:00)</option>
                        <option value="T3">T3 (23:00-07:00)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Letra</label>
                    <select id="letra" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-700 outline-none focus:border-blue-500 text-xs">
                        <option>A</option><option>B</option><option>C</option><option>D</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Respons√°vel *</label>
                    <input type="text" id="operador" placeholder="Nome" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-700 outline-none focus:border-blue-500 text-xs">
                </div>
            </div>
        </div>

        <div id="listaEquipamentos" class="p-4 space-y-6"></div>

        <div class="p-6 bg-[#1e293b] border-t border-slate-700">
            <button onclick="enviarTudo()" id="btnFinalizar" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all transform active:scale-95">
                <i class="fas fa-paper-plane"></i> FINALIZAR E ENVIAR RELAT√ìRIO
            </button>
        </div>
    </div>

    <script>
       const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxRq4RwoWzsF2hMZNFEaQogtOChN_zKwz5gPXsPGknpm17T49xYi08MYkQbzDp4sSPX1Q/exec";

const frotas = {
    "JUMBOS": ["JB01-", "JB02-", "JB04-", "JB05-"],
    "SIMBAS": ["SB01-", "SB02-", "SB04-"],
    "LHDS": ["CG01-", "CG04-", "CG08-"],
    "CARREGADEIRAS CONVENCIONAIS": ["CG02-", "CG07-"],
    "CAMINH√ïES": ["CE06-", "CE07-", "CE08-", "CE09-", "CE10-", "CE11-", "CE12-", "CE13-"],
    "APOIO": ["Trator TE01", "Retroescavadeira RT03", "Retroescavadeira RT05", "Retroescavadeira RT06", "Manipuladora MT04", "Manipuladora MT05", "Manipuladora MT06", "Manipuladora MT07", "Motoniveladora MN01"]
};

const metasDF = { "JUMBOS": 80, "SIMBAS": 70, "CARREGADEIRAS": 70, "CAMINH√ïES": 75, "LHDS": 70, "APOIO": 85 };
const limitesTurno = { "T1": { i: "07:00", f: "15:00" }, "T2": { i: "15:00", f: "23:00" }, "T3": { i: "23:00", f: "07:00" } };

// --- FUN√á√ïES DE PERSIST√äNCIA (STORAGE) ---

function salvarProgresso() {
    const dadosParaSalvar = {
        cabecalho: {
            data: document.getElementById('dataTurno').value,
            turno: document.getElementById('turno').value,
            letra: document.getElementById('letra').value,
            operador: document.getElementById('operador').value
        },
        equipamentos: []
    };

    document.querySelectorAll('.equip-card').forEach(card => {
        const paradas = [];
        card.querySelectorAll('.parada-item').forEach(p => {
            paradas.push({
                h_ini: p.querySelector('.h-ini').value,
                h_fim: p.querySelector('.h-fim').value,
                hor: p.querySelector('.horimetro').value,
                maint: p.querySelector('.maint-status').value,
                motivo: p.querySelector('.motivo').value,
                causa: p.querySelector('.causa').value,
                acao: p.querySelector('.acao').value,
                obs: p.querySelector('.obs').value
            });
        });

        dadosParaSalvar.equipamentos.push({
            id: card.getAttribute('data-equip'),
            status: card.querySelector('.status-geral').value,
            motivoStatus: card.querySelector('.input-motivo-status').value,
            paradas: paradas
        });
    });

    localStorage.setItem('relatorio_operacional_cache', JSON.stringify(dadosParaSalvar));
}

function carregarProgresso() {
    const cache = localStorage.getItem('relatorio_operacional_cache');
    if (!cache) return;

    const dados = JSON.parse(cache);
    
    // Restaurar Cabe√ßalho
    document.getElementById('dataTurno').value = dados.cabecalho.data;
    document.getElementById('turno').value = dados.cabecalho.turno;
    document.getElementById('letra').value = dados.cabecalho.letra;
    document.getElementById('operador').value = dados.cabecalho.operador;

    // Restaurar Equipamentos e Paradas
    dados.equipamentos.forEach((dadosEq, idx) => {
        const card = document.querySelector(`[data-equip="${dadosEq.id}"]`);
        if (card) {
            card.querySelector('.status-geral').value = dadosEq.status;
            const inputMotivo = card.querySelector('.input-motivo-status');
            inputMotivo.value = dadosEq.motivoStatus;
            
            // Mostrar input de motivo se necess√°rio
            if(dadosEq.status === "Corretiva" || dadosEq.status === "Manuten√ß√£o Externa") {
                inputMotivo.classList.remove('hidden');
            }

            // Recriar cada parada
            dadosEq.paradas.forEach(p => {
                const paradaDiv = addParada(idx); // Chama a fun√ß√£o que j√° existe
                paradaDiv.querySelector('.h-ini').value = p.h_ini;
                paradaDiv.querySelector('.h-fim').value = p.h_fim;
                paradaDiv.querySelector('.horimetro').value = p.hor;
                paradaDiv.querySelector('.maint-status').value = p.maint;
                paradaDiv.querySelector('.motivo').value = p.motivo;
                paradaDiv.querySelector('.causa').value = p.causa;
                paradaDiv.querySelector('.acao').value = p.acao;
                paradaDiv.querySelector('.obs').value = p.obs;
            });
        }
    });
}

// --- FUN√á√ïES DE RENDERIZA√á√ÉO E L√ìGICA ---

function renderizar() {
    const container = document.getElementById('listaEquipamentos');
    container.innerHTML = '';
    let globalIdx = 0;

    for (let frota in frotas) {
        container.innerHTML += `<h2 class="text-blue-500 font-black text-xs mt-6 mb-2 border-l-4 border-blue-500 pl-2 uppercase italic"><i class="fas fa-layer-group mr-2"></i>${frota}</h2>`;
        frotas[frota].forEach((eq) => {
            container.innerHTML += `
                <div class="border border-slate-700 rounded-xl p-4 bg-slate-800/40 equip-card mb-4" data-equip="${eq}" data-frota="${frota}">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-3 mb-4 gap-2">
                        <h3 class="font-black text-white text-sm uppercase tracking-wider whitespace-nowrap">${eq}</h3>
                        <div class="flex flex-col flex-1 items-end gap-2">
                            <select onchange="toggleMotivoStatus(this); salvarProgresso()" class="status-geral bg-slate-900 p-2 rounded font-bold text-[10px] border border-slate-700 text-white w-full max-w-[150px]">
                                <option value="Dispon√≠vel">‚úÖ Dispon√≠vel</option>
                                <option value="Preventiva/PitStop">üõ†Ô∏è Preventiva/PitStop</option>
                                <option value="Corretiva">‚ùå Corretiva</option>
                                <option value="Manuten√ß√£o Externa">üö® Servi√ßo Externo</option>
                            </select>
                            <input type="text" oninput="salvarProgresso()" placeholder="Qual o motivo do status? *" class="input-motivo-status hidden w-full bg-slate-900 p-2 rounded text-[10px] border border-amber-500 text-white outline-none">
                        </div>
                    </div>
                    <div id="paradas-${globalIdx}" class="space-y-4"></div>
                    <button type="button" onclick="addParada(${globalIdx})" class="mt-4 text-[10px] font-bold bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded flex items-center gap-2 transition shadow-md uppercase">
                        <i class="fas fa-plus-circle"></i> Iniciar Interven√ß√£o
                    </button>
                </div>`;
            globalIdx++;
        });
    }

    // Ap√≥s renderizar o esqueleto, carrega o que estava salvo
    carregarProgresso();
    
    // Adiciona o evento de salvar em qualquer mudan√ßa no container de equipamentos
    container.addEventListener('input', salvarProgresso);
    container.addEventListener('change', salvarProgresso);
}

function addParada(idx) {
    const container = document.getElementById(`paradas-${idx}`);
    const div = document.createElement('div');
    div.className = "bg-slate-900 p-4 rounded-lg border-l-4 border-amber-500 relative mt-2 parada-item";
    div.innerHTML = `
        <button type="button" onclick="this.parentElement.remove(); salvarProgresso()" class="absolute top-2 right-2 text-slate-500 hover:text-red-500"><i class="fas fa-trash"></i></button>
        <div class="grid grid-cols-3 gap-2 mb-3">
            <div><label class="text-[9px] font-bold text-slate-500 uppercase">In√≠cio</label>
            <input type="time" class="h-ini w-full p-2 bg-slate-800 border border-slate-700 rounded text-white text-xs"></div>
            <div><label class="text-[9px] font-bold text-slate-500 uppercase">Fim</label>
            <input type="time" class="h-fim w-full p-2 bg-slate-800 border border-slate-700 rounded text-white text-xs"></div>
            <div><label class="text-[9px] font-bold text-slate-500 uppercase">Hor√≠metro</label>
            <input type="number" step="0.1" class="horimetro w-full p-2 bg-slate-800 border border-slate-700 rounded text-white text-xs" placeholder="0.0"></div>
        </div>
        <select class="maint-status w-full p-2 mb-2 bg-slate-800 border border-slate-700 rounded text-white text-[10px]">
            <option value="Conclu√≠do">‚úÖ Conclu√≠do</option>
            <option value="Em Diagn√≥stico">üîç Em Diagn√≥stico</option>
            <option value="Em Execu√ß√£o">üõ†Ô∏è Em Execu√ß√£o</option>
            <option value="Aguardando Pe√ßa">üì¶ Aguardando Pe√ßa</option>
        </select>
        <div class="grid grid-cols-1 gap-2">
            <input type="text" class="motivo p-2 bg-slate-800 border border-slate-700 rounded text-[11px] text-white" placeholder="Motivo da Parada *">
            <input type="text" class="causa p-2 bg-slate-800 border border-slate-700 rounded text-[11px] text-white" placeholder="Causa Aparente *">
            <input type="text" class="acao p-2 bg-slate-800 border border-slate-700 rounded text-[11px] text-white" placeholder="A√ß√£o Imediata *">
            <textarea class="obs p-2 bg-slate-800 border border-slate-700 rounded text-[11px] text-white" placeholder="Observa√ß√µes Complementares"></textarea>
        </div>`;
    container.appendChild(div);
    salvarProgresso();
    return div;
}

// ... (Mantenha as fun√ß√µes toggleMotivoStatus, estaNoRange, gerarWhats e enviarTudo conforme seu original) ...

// No final do seu enviarTudo(), ap√≥s o sucesso, limpe o cache:
// localStorage.removeItem('relatorio_operacional_cache');

window.onload = () => {
    document.getElementById('dataTurno').valueAsDate = new Date();
    renderizar();
    
    // Salvar cabe√ßalho quando mudar
    ['dataTurno', 'turno', 'letra', 'operador'].forEach(id => {
        document.getElementById(id).addEventListener('input', salvarProgresso);
    });
};

</html>


